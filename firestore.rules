rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ã‚°ãƒ«ãƒ¼ãƒ—ã®èª­ã¿æ›¸ããƒ«ãƒ¼ãƒ«
    match /groups/{groupId} {
      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª­ã¿å–ã‚Šã‚’è¨±å¯
      allow read: if request.auth != null;

      // ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆã‚’è¨±å¯
      allow create: if request.auth != null;

      // ã‚°ãƒ«ãƒ¼ãƒ—ã®æ›´æ–°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®å‚åŠ ã€ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ã‚„åå‰å¤‰æ›´ãªã©ï¼‰
      allow update: if request.auth != null;

      // ã‚°ãƒ«ãƒ¼ãƒ—ã®å‰Šé™¤ã¯ä½œæˆè€…ã®ã¿è¨±å¯
      allow delete: if request.auth.uid == resource.data.createdBy;
    }

    // ã‚¢ã‚¤ãƒ†ãƒ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ«ãƒ¼ãƒ«
    match /groups/{groupId}/items/{itemId} {
      // ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ãªã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’èª­ã¿å–ã‚Œã‚‹
      allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;

      // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãŒã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã§ãã‚‹
      allow create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;

      // ã‚¢ã‚¤ãƒ†ãƒ ã®ç™»éŒ²è€…ã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãŒæ›´æ–°å¯èƒ½
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.registrant ||
         request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members);

      // ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤ã¯ç™»éŒ²è€…ã®ã¿è¨±å¯
      allow delete: if request.auth.uid == resource.data.registrant;
    }

    match /users/{userId} {
      allow create: if request.auth.uid == userId;  // æ–°è¦ä½œæˆè¨±å¯

      // ğŸ”¥ ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® displayName, colorTheme, themeMode ã‚’å–å¾—å¯èƒ½ã«å¤‰æ›´
      allow read: if request.auth.uid == userId || 
                  resource.data.displayName != null || 
                  resource.data.colorTheme != null || 
                  resource.data.themeMode != null;

      allow update: if request.auth.uid == userId;

      // ğŸ”¥ ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å–å¾—ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’åˆ¶é™
      allow get: if request.auth.uid == userId || 
                  request.resource.data.keys().hasOnly(['displayName', 'colorTheme', 'themeMode']);
}

    // ğŸ”¥ ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ«ãƒ¼ãƒ«
    match /devices/{deviceId} {
      // ğŸ”¥ èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ `read` ã‚’è¨±å¯
      allow read: if request.auth != null;
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®ã¿ä½œæˆãƒ»æ›´æ–°å¯èƒ½
      allow create, update: if request.auth != null && request.auth.uid == request.resource.data.userId;

      // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®å‰Šé™¤ã¯è‡ªåˆ†ã®ã¿è¨±å¯
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
  }
}